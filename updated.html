<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMS - Vehicle Maintenance Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Status Dot Animations */
        @keyframes glow-red { 0%, 100% { box-shadow: 0 0 4px #ef4444; opacity: 1; } 50% { box-shadow: 0 0 12px #ef4444; opacity: 0.8; } }
        @keyframes glow-amber { 0%, 100% { box-shadow: 0 0 4px #f59e0b; opacity: 1; } 50% { box-shadow: 0 0 12px #f59e0b; opacity: 0.8; } }
        @keyframes glow-green { 0%, 100% { box-shadow: 0 0 4px #10b981; opacity: 1; } 50% { box-shadow: 0 0 8px #10b981; opacity: 0.9; } }

        .status-dot-red { animation: glow-red 2s infinite; background-color: #ef4444; }
        .status-dot-amber { animation: glow-amber 2s infinite; background-color: #f59e0b; }
        .status-dot-green { animation: glow-green 3s infinite; background-color: #10b981; }

        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #e2e8f0;
        }

        .premium-input {
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }
        .premium-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.08);
        }

        /* CRITICAL PRINT RESET - Ensures multi-page flow and card layout */
        @media print {
            .no-print { display: none !important; }
            
            body, html, #root {
                height: auto !important;
                overflow: visible !important;
                display: block !important;
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .audit-report-overlay {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                display: block !important;
                background: white !important;
                z-index: auto !important;
            }

            .audit-container {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
                padding: 40px !important;
            }

            .audit-card {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                border: 1px solid #e2e8f0 !important;
                margin-bottom: 30px !important;
                padding: 30px !important;
                border-radius: 12px !important;
                display: block !important;
                box-shadow: none !important;
            }

            img {
                max-height: 400px !important;
                width: auto !important;
                page-break-inside: avoid !important;
                display: block !important;
                margin: 10px auto !important;
            }

            h1, h2, h3, h4 { page-break-after: avoid !important; }
        }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .loader-line {
            height: 2px;
            width: 100%;
            background: #f1f5f9;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }
        .loader-line::after {
            content: '';
            position: absolute;
            left: -50%;
            height: 100%;
            width: 50%;
            background: #3b82f6;
            animation: slide 1.5s infinite ease-in-out;
        }
        @keyframes slide { 0% { left: -50%; } 100% { left: 100%; } }
    </style>
</head>
<body class="bg-[#fcfdfe] text-slate-900">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            setDoc,
            getDoc,
            updateDoc,
            deleteDoc,
            doc,
            onSnapshot, 
            query, 
            where,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.firebaseModules = {
            initializeApp,
            auth: { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously },
            firestore: { getFirestore, collection, addDoc, setDoc, getDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, serverTimestamp }
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- Main Application Script -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 1. CONSTANTS & ICONS ---
        const DEFAULT_SCHEDULE = [
            { id: 'oil', name: 'Engine Oil & Filter', intervalMiles: 10000, intervalMonths: 12, alertEnabled: true },
            { id: 'rotate', name: 'Tire Rotation', intervalMiles: 5000, intervalMonths: 6, alertEnabled: true },
            { id: 'cabin', name: 'Cabin Air Filter', intervalMiles: 20000, intervalMonths: 24, alertEnabled: true },
            { id: 'engine_air', name: 'Engine Air Filter', intervalMiles: 20000, intervalMonths: 24, alertEnabled: true },
            { id: 'reg', name: 'Registration Renewal', intervalMiles: 0, intervalMonths: 12, alertEnabled: true },
        ];

        const Icon = ({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );
        const CarIcon = (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></Icon>;
        const LogOutIcon = (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Icon>;
        const PlusCircleIcon = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></Icon>;
        const AlertTriangleIcon = (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></Icon>;
        const ClockIcon = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const SaveIcon = (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const SettingsIcon = (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const BadgeIcon = (p) => <Icon {...p}><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.78"/></Icon>;
        const KeyIcon = (p) => <Icon {...p}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></Icon>;
        const XIcon = (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const TrashIcon = (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>;
        const LayersIcon = (p) => <Icon {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></Icon>;
        const ImageIcon = (p) => <Icon {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></Icon>;
        const ClipboardCheckIcon = (p) => <Icon {...p}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/><polyline points="16 13 19 16 23 12"/></Icon>;
        const ShieldIcon = (p) => <Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></Icon>;

        // --- 3. UTILS ---
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const d = new Date(dateString);
            return isNaN(d.getTime()) ? 'N/A' : d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200;
                        const ctx = canvas.getContext('2d');
                        let w = img.width, h = img.height;
                        if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
                reader.onerror = reject;
            });
        };

        // --- 4. COMPONENTS ---

        const CircularProgress = ({ percent, status }) => {
            const color = status === 'overdue' ? '#ef4444' : status === 'due' ? '#f59e0b' : '#10b981';
            const radius = 18;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            return (
                <div className="relative w-11 h-11 flex items-center justify-center shrink-0">
                    <svg className="w-full h-full -rotate-90">
                        <circle cx="22" cy="22" r={radius} fill="transparent" stroke="#f1f5f9" strokeWidth="4" />
                        <circle cx="22" cy="22" r={radius} fill="transparent" stroke={color} strokeWidth="4" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" className="transition-all duration-1000" />
                    </svg>
                    <span className="absolute text-[8px] font-black text-slate-400">{Math.round(percent)}%</span>
                </div>
            );
        };

        const DashboardStrip = ({ item, onClick }) => {
            const dotClass = item.status === 'overdue' ? 'status-dot-red' : item.status === 'due' ? 'status-dot-amber' : 'status-dot-green';
            const lifePercent = Math.max(0, Math.min(100, 100 - (item.milesRemaining / item.intervalMiles * 100)));

            return (
                <div 
                    onClick={() => onClick(item)}
                    className="flex items-center gap-4 bg-white p-3 px-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-md hover:border-blue-100 transition-all cursor-pointer group fade-in"
                >
                    <div className={`w-3 h-3 rounded-full shrink-0 ${dotClass}`}></div>
                    <div className="flex-grow">
                        <h4 className="font-bold text-slate-800 text-sm tracking-tight group-hover:text-blue-600 transition-colors uppercase">{item.name}</h4>
                        <div className="flex items-center gap-3 mt-0.5 opacity-60">
                            <span className="text-[9px] font-black uppercase tracking-widest text-slate-400">Next due</span>
                            <span className={`text-[9px] font-black ${item.status === 'overdue' ? 'text-red-500' : 'text-slate-600'}`}>{formatDate(item.projectedDate)}</span>
                        </div>
                    </div>
                    {!item.isTimeOnly ? <CircularProgress percent={lifePercent} status={item.status} /> : <ClockIcon size={14} className="text-slate-200 mr-2"/>}
                </div>
            );
        };

        const SummaryCard = ({ label, value, subValue, colorClass, icon: IconComp }) => (
            <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-between h-full hover:border-blue-200 transition-colors">
                <div className="flex justify-between items-start mb-2">
                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{label}</span>
                    {IconComp && <IconComp size={16} className="text-slate-300" />}
                </div>
                <div>
                    <div className={`text-2xl font-black tracking-tighter ${colorClass} truncate leading-none`}>{value}</div>
                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">{subValue}</div>
                </div>
            </div>
        );

        const AlertBanner = ({ items }) => {
            const overdue = items.filter(i => i.status === 'overdue' && i.alertEnabled !== false);
            if (overdue.length === 0) return null;
            return (
                <div className="mb-6 bg-red-50 border border-red-200 text-red-900 p-4 rounded-xl shadow-sm flex items-center gap-3">
                    <AlertTriangleIcon size={18} className="shrink-0 text-red-600" />
                    <p className="text-[10px] font-black tracking-widest uppercase text-red-800">{overdue.length} items require attention</p>
                </div>
            );
        };

        // --- 5. MODALS & FORMS ---

        const Login = ({ auth, onGuestLogin }) => {
            const [mode, setMode] = useState('login'); 
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [guestCode, setGuestCode] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); setError(''); setIsLoading(true);
                try {
                    const { auth: fbAuth } = window.firebaseModules;
                    if (mode === 'register') await fbAuth.createUserWithEmailAndPassword(auth, email, password);
                    else await fbAuth.signInWithEmailAndPassword(auth, email, password);
                } catch (err) { setError(err.message.replace('Firebase: ', '')); setIsLoading(false); }
            };

            const handleGuestSubmit = (e) => {
                e.preventDefault(); if (!guestCode.trim()) return; setIsLoading(true);
                onGuestLogin(guestCode.trim().toUpperCase()).catch(err => { setError(err.message); setIsLoading(false); });
            };

            return (
                <div className="min-h-screen bg-[#fcfdfe] flex flex-col items-center justify-center p-6">
                    <div className="bg-white border border-slate-200 p-10 md:p-14 rounded-[2.5rem] shadow-xl shadow-slate-200/50 w-full max-w-md text-center fade-in">
                        <div className="mb-8 flex justify-center">
                            <div className="bg-slate-900 text-white p-4 rounded-3xl shadow-lg">
                                <CarIcon size={32} />
                            </div>
                        </div>
                        <h1 className="text-3xl font-black text-slate-900 tracking-tighter mb-2 uppercase">Service Tracker</h1>
                        <p className="text-xs text-slate-500 font-medium mb-12 uppercase tracking-widest leading-none">Authorized Access Only</p>
                        
                        {error && <div className="bg-red-50 text-red-600 p-4 rounded-2xl mb-8 text-xs font-bold border border-red-100">{error}</div>}
                        
                        {mode === 'guest' ? (
                            <form onSubmit={handleGuestSubmit} className="space-y-6">
                                <input type="text" required maxLength="6" placeholder="Access Code" className="w-full bg-slate-50 border border-slate-200 rounded-2xl p-5 text-center text-3xl font-mono uppercase tracking-[0.3em] outline-none focus:border-blue-500 transition-all shadow-inner font-mono" value={guestCode} onChange={e => setGuestCode(e.target.value)} />
                                <button type="submit" disabled={isLoading} className="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-blue-700 transition-all shadow-lg shadow-blue-600/20 active:scale-95">{isLoading ? 'Validating...' : 'Verify Access'}</button>
                                <button type="button" onClick={() => setMode('login')} className="text-xs font-black text-slate-400 hover:text-slate-900 uppercase tracking-widest transition-colors">Return to Sign In</button>
                            </form>
                        ) : (
                            <form onSubmit={handleAuth} className="space-y-5 text-left">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Email Address</label>
                                    <input type="email" className="w-full premium-input p-5 rounded-2xl text-sm font-bold outline-none shadow-sm" placeholder="user@example.com" value={email} onChange={e => setEmail(e.target.value)} required />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Password</label>
                                    <input type="password" className="w-full premium-input p-5 rounded-2xl text-sm outline-none shadow-sm" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} required />
                                </div>
                                <button type="submit" disabled={isLoading} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.3em] mt-4 shadow-xl hover:bg-slate-800 active:scale-95 transition-all">{isLoading ? 'Syncing...' : 'Sign In'}</button>
                                <div className="flex flex-col gap-6 mt-10 text-center">
                                    <button type="button" onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-[10px] font-black text-blue-600 uppercase tracking-widest hover:underline underline-offset-4">{mode === 'login' ? 'Create New Account' : 'Back to Login'}</button>
                                    <div className="h-px bg-slate-100 w-full"></div>
                                    <button type="button" onClick={() => setMode('guest')} className="text-[10px] font-black text-slate-400 hover:text-slate-900 uppercase tracking-widest">Enter as Guest</button>
                                </div>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        const ServiceForm = ({ user, initialData, onClose, db, appId, schedule }) => {
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isCompressing, setIsCompressing] = useState(false);
            const [mode, setMode] = useState('single');
            const [formData, setFormData] = useState({
                date: initialData?.date || new Date().toISOString().split('T')[0],
                mileage: initialData?.mileage || '',
                serviceType: initialData?.serviceType || schedule[0]?.name || 'Oil Change',
                parts: initialData?.parts || '',
                skuReference: initialData?.skuReference || '',
                receiptImage: initialData?.receiptImage || null
            });
            const [multiSelection, setMultiSelection] = useState({});

            const handleFileChange = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    setIsCompressing(true);
                    try { const compressed = await compressImage(e.target.files[0]); setFormData(prev => ({ ...prev, receiptImage: compressed })); } 
                    catch (err) { alert("Error processing image"); } finally { setIsCompressing(false); }
                }
            };

            const toggleMulti = (name) => {
                setMultiSelection(prev => {
                    const next = { ...prev };
                    if (next[name]) delete next[name]; else next[name] = true;
                    return next;
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault(); setIsSubmitting(true);
                const { firestore: fsMod } = window.firebaseModules;
                try {
                    const base = { date: formData.date, mileage: Number(formData.mileage), timestamp: fsMod.serverTimestamp() };
                    if (mode === 'single') {
                        const payload = { ...base, serviceType: formData.serviceType, parts: formData.parts, skuReference: formData.skuReference, receiptImage: formData.receiptImage };
                        if (initialData) await fsMod.updateDoc(fsMod.doc(db, 'artifacts', appId, 'users', user.uid, 'serviceRecords', initialData.id), payload);
                        else await fsMod.addDoc(fsMod.collection(db, 'artifacts', appId, 'users', user.uid, 'serviceRecords'), payload);
                    } else {
                        const promises = Object.keys(multiSelection).map(name => {
                            return fsMod.addDoc(fsMod.collection(db, 'artifacts', appId, 'users', user.uid, 'serviceRecords'), { ...base, serviceType: name, parts: 'Multi-service entry', receiptImage: formData.receiptImage });
                        });
                        await Promise.all(promises);
                    }
                    onClose();
                } catch (err) { alert(err.message); } finally { setIsSubmitting(false); }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center p-4 z-50 backdrop-blur-md no-print">
                    <div className="bg-white rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden fade-in max-h-[90vh] flex flex-col">
                        <div className="p-8 border-b flex justify-between items-center bg-slate-900 text-white shrink-0">
                            <div><h2 className="font-black uppercase tracking-widest text-[10px] opacity-40">Entry</h2><p className="text-sm font-bold uppercase tracking-widest">{initialData ? 'Edit Record' : 'New Log'}</p></div>
                            <button onClick={onClose} className="opacity-40 hover:opacity-100 transition-opacity"><XIcon size={24}/></button>
                        </div>
                        
                        <div className="flex bg-slate-100 p-2 m-6 rounded-2xl shrink-0 shadow-inner">
                            <button onClick={() => setMode('single')} className={`flex-1 py-2 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all ${mode === 'single' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>Single Item</button>
                            <button onClick={() => setMode('multi')} className={`flex-1 py-2 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all flex items-center justify-center gap-2 ${mode === 'multi' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}><LayersIcon size={12}/> Multi-Service</button>
                        </div>

                        <form onSubmit={handleSubmit} className="p-10 pt-0 space-y-5 overflow-y-auto">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Date</label><input type="date" className="w-full premium-input p-4 rounded-2xl text-xs font-bold outline-none" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} required /></div>
                                <div className="space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Mileage</label><input type="number" className="w-full premium-input p-4 rounded-2xl text-xs font-mono font-bold outline-none" value={formData.mileage} onChange={e => setFormData({...formData, mileage: e.target.value})} required /></div>
                            </div>

                            {mode === 'single' ? (
                                <div className="space-y-4">
                                    <div className="space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Service Type</label><select className="w-full premium-input p-4 rounded-2xl text-xs font-bold bg-white outline-none appearance-none" value={formData.serviceType} onChange={e => setFormData({...formData, serviceType: e.target.value})}>{schedule.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}<option value="Other">Other</option></select></div>
                                    <div className="space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Details</label><input className="w-full premium-input p-4 rounded-2xl text-xs outline-none" placeholder="Description of work..." value={formData.parts} onChange={e => setFormData({...formData, parts: e.target.value})} /></div>
                                </div>
                            ) : (
                                <div className="space-y-2"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Tasks Completed</label><div className="flex flex-wrap gap-2">{schedule.map(s => <button key={s.id} type="button" onClick={() => toggleMulti(s.name)} className={`px-4 py-2 rounded-full border text-[10px] font-bold uppercase transition-all ${multiSelection[s.name] ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-slate-50 border-slate-200 text-slate-400'}`}>{s.name}</button>)}</div></div>
                            )}

                            <div className="space-y-2 pt-2">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Receipt</label>
                                {!formData.receiptImage ? (
                                    <div className="border-2 border-dashed border-slate-200 rounded-2xl p-6 text-center hover:border-blue-400 transition-all relative cursor-pointer group">
                                        <input type="file" accept="image/*" onChange={handleFileChange} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        <div className="flex flex-col items-center gap-2">
                                            {isCompressing ? <div className="w-5 h-5 border-2 border-blue-600 border-t-transparent animate-spin rounded-full"></div> : <ImageIcon size={24} className="text-slate-300 group-hover:text-blue-500"/>}
                                            <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Attach Receipt Image</span>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="relative inline-block rounded-2xl overflow-hidden border-2 border-slate-100 shadow-md">
                                        <img src={formData.receiptImage} className="h-20 w-auto object-cover" />
                                        <button onClick={() => setFormData({...formData, receiptImage: null})} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1"><XIcon size={12}/></button>
                                    </div>
                                )}
                            </div>

                            <button type="submit" disabled={isSubmitting || isCompressing} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-[0.3em] text-[10px] mt-6 shadow-xl active:scale-95 transition-all disabled:opacity-50">Confirm Entry</button>
                        </form>
                    </div>
                </div>
            );
        };

        const FullAuditReport = ({ records, vehicleProfile, onClose }) => {
            const sorted = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
            return (
                <div className="fixed inset-0 bg-white z-[100] overflow-y-auto fade-in audit-report-overlay h-auto">
                    <div className="glass-nav p-5 text-slate-900 flex justify-between items-center no-print sticky top-0 shadow-sm z-[101]">
                        <div className="flex items-center gap-3 font-black uppercase tracking-widest text-[10px]"><CarIcon size={18} className="text-blue-600"/>Service History Report</div>
                        <div className="flex gap-3 font-mono">
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-8 py-2 rounded-xl font-bold text-[10px] uppercase tracking-widest hover:bg-slate-800 transition-all shadow-lg shadow-slate-200">Print Report</button>
                            <button onClick={onClose} className="px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 border border-slate-200 transition-all">Exit</button>
                        </div>
                    </div>
                    
                    <div className="max-w-5xl mx-auto p-12 lg:p-20 audit-container overflow-visible h-auto">
                        <div className="border-b-4 border-slate-900 pb-12 mb-16 flex justify-between items-end">
                            <div>
                                <h1 className="text-6xl font-black uppercase tracking-tighter leading-none mb-4 font-mono">Service Log</h1>
                                <p className="text-slate-400 font-bold uppercase tracking-[0.4em] text-xs">Complete Maintenance Documentation</p>
                            </div>
                            <div className="text-right">
                                <div className="bg-slate-900 text-white px-4 py-1 text-xl font-black rounded mb-2 inline-block font-mono uppercase">HTMS</div>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-mono">{new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-10 bg-slate-50 p-10 rounded-[2.5rem] mb-12 border border-slate-100 shadow-inner">
                            <div>
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-mono font-bold">Vehicle Details</h3>
                                <p className="text-3xl font-black text-slate-900 tracking-tighter uppercase leading-none font-mono">{vehicleProfile.yearMakeModel || 'Generic Platform'}</p>
                                <p className="font-mono text-xs text-slate-500 mt-2 uppercase tracking-widest font-mono">VIN: {vehicleProfile.vin || 'N/A'}</p>
                            </div>
                            <div className="text-right">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-mono font-bold">Certified Owner</h3>
                                <p className="text-3xl font-black text-slate-900 tracking-tighter uppercase leading-none font-mono">{vehicleProfile.ownerName || 'UNREGISTERED'}</p>
                                <p className="font-mono text-xs text-slate-500 mt-2 uppercase tracking-widest font-mono font-bold">Total Entries: {records.length}</p>
                            </div>
                        </div>

                        <div className="space-y-10 overflow-visible h-auto">
                            {sorted.map((r, idx) => (
                                <div key={r.id} className="audit-card bg-white border border-slate-200 p-10 rounded-[2.5rem] shadow-sm relative">
                                    <div className="flex justify-between items-start mb-8 border-b border-slate-50 pb-6">
                                        <div className="flex items-center gap-6">
                                            <div className="bg-slate-100 text-slate-900 font-black text-2xl w-14 h-14 flex items-center justify-center rounded-2xl border border-slate-200 font-mono">{sorted.length - idx}</div>
                                            <div>
                                                <h4 className="text-3xl font-black text-slate-900 uppercase tracking-tighter leading-none mb-1 font-mono">{r.serviceType}</h4>
                                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest font-mono">{formatDate(r.date)}</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-mono font-black text-blue-600 text-3xl tracking-tighter leading-none font-mono">{r.mileage.toLocaleString()} mi</div>
                                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1 font-mono">Odometer Reading</p>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
                                        <div className="space-y-6">
                                            <div className="bg-slate-50/50 p-6 rounded-2xl border border-slate-100">
                                                <h5 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-mono">Documentation</h5>
                                                <p className="text-base font-medium text-slate-800 leading-relaxed italic">"{r.parts || 'No specific maintenance details provided.'}"</p>
                                            </div>
                                            {r.skuReference && (
                                                <div className="px-6">
                                                    <h5 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 font-mono">Part / SKU</h5>
                                                    <p className="font-mono font-bold text-slate-900 text-xs uppercase tracking-widest font-mono font-bold font-mono">{r.skuReference}</p>
                                                </div>
                                            )}
                                        </div>
                                        {r.receiptImage && (
                                            <div className="flex flex-col items-center md:items-end overflow-visible">
                                                <h5 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 self-center md:self-end font-mono">Receipt Image Documentation</h5>
                                                <div className="inline-block border-2 border-slate-100 rounded-2xl shadow-lg overflow-hidden bg-white max-w-full">
                                                    <img src={r.receiptImage} className="max-h-[450px] w-auto object-contain block" />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mt-24 pt-12 border-t border-slate-200 text-center opacity-30 h-auto">
                            <p className="text-[10px] font-black uppercase tracking-[0.5em] mb-3">End of Report</p>
                            <p className="font-mono text-[9px] font-mono">Verified History Report • HTMS System Certificate • Digital Registry Verified</p>
                        </div>
                    </div>
                </div>
            );
        };

        const ScheduleManager = ({ user, db, appId, currentSchedule, onClose, onUpdate }) => {
            const { setDoc, doc } = window.firebaseModules.firestore;
            const [items, setItems] = useState(currentSchedule);
            const [newItem, setNewItem] = useState({ name: '', intervalMiles: 5000, intervalMonths: 6, alertEnabled: true });
            const save = async (list) => { await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'maintenanceSchedule'), { items: list }); onUpdate(list); };
            const handleAdd = () => { if(!newItem.name) return; const up = [...items, {...newItem, id: Date.now().toString()}]; setItems(up); save(up); setNewItem({name:'', intervalMiles:5000, intervalMonths:6, alertEnabled: true}); };
            const handleDelete = (id) => { if(confirm('Delete reminder?')) { const up = items.filter(i=>i.id!==id); setItems(up); save(up); } };
            return (
                <div className="fixed inset-0 bg-slate-950/80 flex items-center justify-center p-4 z-50 backdrop-blur-md font-mono">
                    <div className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden fade-in">
                        <div className="p-8 border-b flex justify-between items-center bg-slate-900 text-white shrink-0">
                            <h2 className="font-black uppercase tracking-widest text-[10px]">Maintenance Plan</h2>
                            <button onClick={onClose}><XIcon size={24}/></button>
                        </div>
                        <div className="p-8 overflow-y-auto space-y-4 bg-slate-50/50">
                            <div className="flex gap-2 mb-8 bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
                                <input placeholder="Task" className="flex-grow p-2 text-xs font-bold uppercase tracking-widest outline-none" value={newItem.name} onChange={e=>setNewItem({...newItem, name: e.target.value})}/>
                                <input type="number" placeholder="Mi" className="w-20 text-xs font-mono font-bold text-center outline-none border-x border-slate-100" value={newItem.intervalMiles} onChange={e=>setNewItem({...newItem, intervalMiles: Number(e.target.value)})}/>
                                <button onClick={handleAdd} className="bg-blue-600 text-white px-6 py-2 rounded-xl font-black uppercase text-[9px] active:scale-95 transition-all">Add</button>
                            </div>
                            <div className="space-y-2">{items.map(i => (
                                <div key={i.id} className="flex items-center justify-between p-4 bg-white rounded-xl border border-slate-100 group shadow-sm">
                                    <span className="font-black text-xs uppercase tracking-tight text-slate-700 font-mono">{i.name}</span>
                                    <div className="flex items-center gap-4">
                                        <span className="text-[10px] font-black text-slate-400 uppercase font-mono tracking-tighter">Every {i.intervalMiles.toLocaleString()} mi</span>
                                        <button onClick={() => handleDelete(i.id)} className="text-red-400 hover:text-red-600 transition-colors opacity-0 group-hover:opacity-100"><TrashIcon size={16}/></button>
                                    </div>
                                </div>
                            ))}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const VehicleProfileModal = ({ user, db, appId, currentProfile, onClose, onUpdate }) => {
            const { setDoc, doc } = window.firebaseModules.firestore;
            const [p, setP] = useState(currentProfile);
            const save = async (e) => { e.preventDefault(); await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'vehicleProfile'), p); onUpdate(p); onClose(); };
            return (
                <div className="fixed inset-0 bg-slate-950/80 flex items-center justify-center p-4 z-50 backdrop-blur-md">
                    <div className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-10 fade-in font-mono">
                        <div className="flex items-center gap-6 mb-10"><div className="bg-slate-100 p-4 rounded-2xl text-slate-900 shadow-inner"><BadgeIcon size={32}/></div><div><h2 className="font-black text-xl tracking-tighter uppercase leading-none text-slate-900">Vehicle Info</h2><p className="text-slate-400 text-[9px] font-black tracking-widest uppercase mt-1">Identity Profile</p></div></div>
                        <form onSubmit={save} className="space-y-5">
                            <div className="space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1 font-mono">Owner Name</label><input className="w-full premium-input p-4 rounded-xl outline-none font-bold text-sm shadow-sm" value={p.ownerName} onChange={e=>setP({...p,ownerName:e.target.value})} required/></div>
                            <div className="space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1 font-mono">Vehicle Model</label><input className="w-full premium-input p-4 rounded-xl outline-none font-bold text-sm shadow-sm" value={p.yearMakeModel} onChange={e=>setP({...p,yearMakeModel:e.target.value})} required/></div>
                            <div className="space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1 font-mono">VIN Number</label><input className="w-full premium-input p-4 rounded-xl outline-none font-mono uppercase font-black text-xs tracking-widest shadow-sm" value={p.vin} onChange={e=>setP({...p,vin:e.target.value})} required/></div>
                            <button className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-[0.3em] text-[10px] shadow-xl mt-4 active:scale-95 transition-all">Save Changes</button>
                            <button type="button" onClick={onClose} className="w-full text-[9px] font-black text-slate-400 uppercase tracking-widest text-center mt-2">Cancel</button>
                        </form>
                    </div>
                </div>
            );
        };

        const ShareAccessModal = ({ user, db, appId, currentData, onClose }) => {
            const { setDoc, doc, collection, query, where, onSnapshot, deleteDoc } = window.firebaseModules.firestore;
            const [duration, setDuration] = useState(86400000); 
            const [generatedCode, setGeneratedCode] = useState('');
            const [activeCodes, setActiveCodes] = useState([]);

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'guestCodes'), snap => {
                    const codes = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(c => c.ownerUid === user.uid);
                    setActiveCodes(codes);
                });
                return () => unsub();
            }, [user.uid, db, appId]);

            const generate = async () => {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const payload = { profile: currentData.profile, schedule: currentData.schedule, records: currentData.records, odo: currentData.odo, ownerUid: user.uid, createdAt: Date.now(), expiresAt: Date.now() + duration };
                try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'guestCodes', code), payload); setGeneratedCode(code); } catch (e) { alert(e.message); }
            };

            const revoke = async (codeId) => {
                if(!confirm("Revoke access immediately?")) return;
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'guestCodes', codeId)); } catch (e) { alert(e.message); }
            };

            return (
                <div className="fixed inset-0 bg-slate-950/80 flex items-center justify-center p-4 z-50 backdrop-blur-md">
                    <div className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm overflow-hidden fade-in font-mono text-center">
                        <div className="bg-indigo-600 p-8 text-white"><h2 className="font-black text-2xl tracking-tighter uppercase flex items-center gap-4 justify-center leading-none font-mono"><KeyIcon size={24}/> Share Access</h2><p className="text-indigo-200 text-[10px] font-black uppercase tracking-widest mt-1">Snapshot Management</p></div>
                        <div className="p-10 space-y-8 max-h-[70vh] overflow-y-auto bg-slate-50/50">
                            <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-inner">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 text-center font-mono font-bold">New access key</h3>
                                <div className="flex flex-col gap-3">
                                    <select className="premium-input bg-white px-4 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none shadow-sm font-mono" value={duration} onChange={e => setDuration(Number(e.target.value))}><option value={3600000}>1 Hour Session</option><option value={86400000}>24 Hour Session</option><option value={604800000}>7 Day Session</option></select>
                                    <button onClick={generate} className="bg-indigo-600 text-white py-4 rounded-xl font-black uppercase tracking-widest text-[10px] shadow-lg shadow-indigo-500/20 active:scale-95 transition-all font-mono">Create Key</button>
                                </div>
                                {generatedCode && (<div className="mt-8 bg-slate-900 p-6 rounded-2xl border-2 border-indigo-500 text-center shadow-2xl animate-in zoom-in-95"><span className="block text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-2 font-mono">Active Key</span><span className="block text-4xl font-mono font-black text-white tracking-[0.3em] select-all leading-none py-2 font-mono font-mono">{generatedCode}</span></div>)}
                            </div>
                            
                            <div className="space-y-4">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2 font-mono text-left font-bold uppercase">Active Keys</h3>
                                <div className="space-y-2">
                                    {activeCodes.map(code => {
                                        const isExpired = Date.now() > code.expiresAt;
                                        return (
                                            <div key={code.id} className="bg-white border border-slate-100 p-4 rounded-2xl flex justify-between items-center shadow-sm">
                                                <div className="text-left font-mono">
                                                    <span className="font-mono font-black text-slate-900 block font-mono font-bold leading-none mb-1">{code.id}</span>
                                                    <span className={`text-[8px] font-bold uppercase font-mono ${isExpired ? 'text-red-500' : 'text-slate-400'}`}>
                                                        {isExpired ? 'EXPIRED' : `Till ${new Date(code.expiresAt).toLocaleDateString()}`}
                                                    </span>
                                                </div>
                                                <button onClick={() => revoke(code.id)} className="text-red-400 hover:text-red-600 transition-colors p-2"><TrashIcon size={16}/></button>
                                            </div>
                                        );
                                    })}
                                    {activeCodes.length === 0 && <p className="text-center py-4 text-[10px] font-bold text-slate-300 uppercase tracking-widest font-mono font-bold">No keys active</p>}
                                </div>
                            </div>
                            <button onClick={onClose} className="w-full text-[9px] font-black text-slate-400 uppercase tracking-widest text-center hover:text-slate-900 transition-colors pt-4 font-mono font-bold uppercase">Done</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { initializeApp, auth: authMod, firestore: fsMod } = window.firebaseModules;
            const firebaseConfig = { apiKey: "AIzaSyDHEOTsbzOMcFybpHdNLRi94edBOc2eA-s", authDomain: "homemaint-5e4c5.firebaseapp.com", projectId: "homemaint-5e4c5", storageBucket: "homemaint-5e4c5.firebasestorage.app", messagingSenderId: "1026666678068", appId: "1:1026666678068:web:76fad71dc8e855a08bc761" };
            const app = useMemo(() => initializeApp(firebaseConfig), []);
            const auth = useMemo(() => authMod.getAuth(app), [app]);
            const db = useMemo(() => fsMod.getFirestore(app), [app]);
            const appId = 'diy-warranty-tracker';

            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [records, setRecords] = useState([]);
            const [schedule, setSchedule] = useState(DEFAULT_SCHEDULE);
            const [currentOdo, setCurrentOdo] = useState(0);
            const [vehicleProfile, setVehicleProfile] = useState({});
            const [isGuest, setIsGuest] = useState(false);
            
            const [showForm, setShowForm] = useState(false);
            const [showSched, setShowSched] = useState(false);
            const [showIdentity, setShowIdentity] = useState(false);
            const [showAudit, setShowAudit] = useState(false);
            const [showShare, setShowShare] = useState(false);

            useEffect(() => {
                const unsub = authMod.onAuthStateChanged(auth, u => { if (!isGuest) { setUser(u); if(!u) setLoading(false); } });
                return unsub;
            }, [auth, authMod, isGuest]);

            useEffect(() => {
                if (!user || isGuest) return;
                setLoading(true);
                const queryRef = fsMod.query(fsMod.collection(db, 'artifacts', appId, 'users', user.uid, 'serviceRecords'));
                const unsubRecs = fsMod.onSnapshot(queryRef, snap => {
                    setRecords(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                const loadSettings = async () => {
                    try {
                        const snapOdo = await fsMod.getDoc(fsMod.doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'general'));
                        if (snapOdo.exists()) setCurrentOdo(snapOdo.data().currentOdo || 0);
                        const snapSch = await fsMod.getDoc(fsMod.doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'maintenanceSchedule'));
                        if (snapSch.exists() && snapSch.data().items) setSchedule(snapSch.data().items);
                        const snapPro = await fsMod.getDoc(fsMod.doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'vehicleProfile'));
                        if (snapPro.exists()) setVehicleProfile(snapPro.data());
                    } catch (e) { console.error(e); } finally { setLoading(false); }
                };
                loadSettings();
                return unsubRecs;
            }, [user, db, appId, fsMod, isGuest]);

            const handleUpdateOdo = async (val) => {
                if (isGuest) return;
                setCurrentOdo(val);
                await fsMod.setDoc(fsMod.doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'general'), { currentOdo: val }, { merge: true });
            };

            const handleGuestLogin = async (code) => {
                setLoading(true);
                try {
                    // AUTH FIRST
                    await authMod.signInWithEmailAndPassword(auth, 'openaccess@open.com', 'openaccess');
                    
                    const snap = await fsMod.getDoc(fsMod.doc(db, 'artifacts', appId, 'public', 'data', 'guestCodes', code));
                    if (!snap.exists()) throw new Error("Access Key not found.");
                    const d = snap.data();
                    if (Date.now() > d.expiresAt) throw new Error("Access Key has expired.");
                    
                    setIsGuest(true); 
                    setRecords(d.records || []); 
                    setSchedule(d.schedule || DEFAULT_SCHEDULE); 
                    setCurrentOdo(d.odo || 0); 
                    setVehicleProfile(d.profile || {});
                    setLoading(false);
                } catch (e) { 
                    alert(e.message);
                    setLoading(false);
                }
            };

            const processedItems = schedule.map(item => {
                const isTimeOnly = Number(item.intervalMiles) === 0;
                const relevantRecords = records.filter(r => r.serviceType === item.name).sort((a, b) => b.mileage - a.mileage);
                const lastService = relevantRecords[0] || { date: '2020-01-01', mileage: 0 };
                const milesDrivenSince = currentOdo - lastService.mileage;
                const daysSince = (new Date().getTime() - new Date(lastService.date).getTime()) / (1000 * 3600 * 24);
                const milesRemaining = (item.intervalMiles || 5000) - milesDrivenSince;
                const daysRemaining = ((item.intervalMonths || 6) * 30) - daysSince;
                let status = 'good';
                if (daysRemaining < 0 || (!isTimeOnly && milesRemaining < 0)) status = 'overdue';
                else if (daysRemaining < 30 || (!isTimeOnly && milesRemaining < 1000)) status = 'due';
                let projectedDate = new Date();
                if (isTimeOnly) {
                    projectedDate = new Date(lastService.date);
                    projectedDate.setMonth(projectedDate.getMonth() + (item.intervalMonths || 6));
                } else {
                    const daysUntilLimit = milesRemaining / (20000 / 365);
                    projectedDate.setDate(projectedDate.getDate() + (isFinite(daysUntilLimit) ? daysUntilLimit : 0));
                }
                return { ...item, isTimeOnly, status, milesRemaining, projectedDate };
            }).sort((a, b) => {
                if (a.isTimeOnly && !b.isTimeOnly) return 1;
                if (!a.isTimeOnly && b.isTimeOnly) return -1;
                return a.milesRemaining - b.milesRemaining;
            });

            const criticalCount = processedItems.filter(i => i.status === 'overdue').length;
            const nextDueItem = processedItems[0];

            if (loading) return (
                <div className="h-screen bg-white flex flex-col items-center justify-center p-8 text-center font-mono">
                    <div className="w-full max-w-xs space-y-12 fade-in">
                        <div className="flex justify-center mb-10"><CarIcon size={48} className="text-blue-600 animate-pulse" /></div>
                        <div className="space-y-6">
                            <h2 className="text-xs font-black uppercase tracking-[0.6em] text-slate-400 leading-none mb-1 font-mono font-bold">Booting</h2>
                            <div className="loader-line"></div>
                            <p className="text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest font-mono font-bold">Vehicle Records</p>
                        </div>
                    </div>
                </div>
            );

            if (!user && !isGuest) return <Login auth={auth} onGuestLogin={handleGuestLogin} />;

            return (
                <div className="min-h-screen bg-[#f8fafc] text-slate-900 pb-20 overflow-visible h-auto">
                    <nav className="glass-nav text-slate-900 sticky top-0 z-40 px-8 py-5 flex justify-between items-center no-print">
                        <div className="flex items-center gap-4">
                            <div className="bg-slate-900 text-white p-2 rounded-xl shadow-lg"><CarIcon size={20} /></div>
                            <div>
                                <span className="font-black uppercase tracking-tighter text-2xl leading-none">HTMS</span>
                                {isGuest && <span className="block text-[8px] font-black uppercase text-amber-500 tracking-widest mt-1 font-mono font-bold">Authorized Session</span>}
                            </div>
                        </div>
                        <div className="flex items-center gap-3 font-mono">
                            <div className="hidden md:flex bg-slate-100 rounded-xl overflow-hidden border border-slate-200 mr-4">
                                <button onClick={() => setView('dashboard')} className={`px-5 py-2.5 text-[9px] font-black uppercase tracking-widest transition-all ${view === 'dashboard' ? 'bg-white text-slate-950 shadow-sm font-black' : 'text-slate-400 hover:text-slate-900'}`}>Dashboard</button>
                                <button onClick={() => setView('audit')} className={`px-5 py-2.5 text-[9px] font-black uppercase tracking-widest transition-all ${view === 'audit' ? 'bg-white text-slate-950 shadow-sm font-black' : 'text-slate-400 hover:text-slate-900'}`}>History</button>
                            </div>
                            {!isGuest && (
                                <>
                                    <button onClick={() => setShowIdentity(true)} className="p-3 hover:bg-slate-100 rounded-xl transition-all" title="Identity"><BadgeIcon size={20} className="text-slate-400"/></button>
                                    <button onClick={() => setShowSched(true)} className="p-3 hover:bg-slate-100 rounded-xl transition-all" title="Setup"><SettingsIcon size={20} className="text-slate-400"/></button>
                                    <button onClick={() => setShowShare(true)} className="p-3 hover:bg-slate-100 rounded-xl transition-all text-indigo-400" title="Authorizations"><KeyIcon size={20}/></button>
                                </>
                            )}
                            <button onClick={() => { if(isGuest) window.location.reload(); else authMod.signOut(auth); }} className="p-3 hover:bg-red-50 rounded-xl transition-all text-red-400" title="Sign Out"><LogOutIcon size={20}/></button>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto px-8 py-14 h-auto overflow-visible">
                        {view === 'dashboard' ? (
                            <div className="space-y-12 h-auto overflow-visible fade-in">
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 font-mono font-bold">
                                    <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-between h-full hover:border-blue-200 transition-colors font-mono font-bold">
                                        <div className="flex justify-between items-start mb-2 font-mono"><span className="text-[10px] font-black text-slate-400 uppercase tracking-widest font-mono">Mileage</span><SaveIcon size={16} className="text-slate-200" /></div>
                                        <div className="flex items-end gap-2 font-mono leading-none">
                                            <input type="number" className="bg-transparent font-black text-2xl w-full outline-none text-blue-600 tracking-tighter font-mono" value={currentOdo} onChange={e => handleUpdateOdo(Number(e.target.value))} readOnly={isGuest} />
                                            <span className="text-[10px] font-black text-slate-300 pb-1 uppercase font-mono font-bold">MI</span>
                                        </div>
                                    </div>
                                    <SummaryCard label="Alerts" value={criticalCount} subValue="Overdue Fixes" colorClass={criticalCount > 0 ? "text-red-600" : "text-emerald-500"} icon={AlertTriangleIcon} />
                                    <SummaryCard label="Due Next" value={nextDueItem ? formatDate(nextDueItem.projectedDate) : 'None'} subValue={nextDueItem ? nextDueItem.name : 'Clear'} colorClass="text-slate-900 font-bold" icon={ClockIcon} />
                                    <SummaryCard label="Identity" value={vehicleProfile.yearMakeModel || 'Add Car'} subValue={vehicleProfile.vin || 'Add VIN'} colorClass="text-slate-900 truncate font-bold" icon={BadgeIcon} />
                                </div>

                                <div className="h-auto overflow-visible font-mono">
                                    <div className="flex justify-between items-center mb-6">
                                        <div><h3 className="text-sm font-black uppercase tracking-widest text-slate-900 font-mono font-bold uppercase">Maintenance Status</h3><p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1 leading-none font-mono">Sorted by mileage urgency</p></div>
                                        {!isGuest && <button onClick={() => setShowForm(true)} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-[10px] uppercase tracking-widest shadow-xl hover:bg-slate-800 flex items-center gap-3 active:scale-95 transition-all font-mono font-black uppercase"><PlusCircleIcon size={16}/> Log Maintenance</button>}
                                    </div>
                                    <AlertBanner items={processedItems} />
                                    <div className="space-y-2.5">
                                        {processedItems.map(i => (
                                            <DashboardStrip key={i.id} item={i} onClick={() => { setView('audit'); }} />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-8 fade-in h-auto overflow-visible font-mono">
                                <div className="flex justify-between items-end font-bold">
                                    <h2 className="text-4xl font-black tracking-tighter uppercase leading-none text-slate-900 font-mono">Service History</h2>
                                    <button onClick={() => setShowAudit(true)} className="text-[10px] font-black text-blue-600 uppercase tracking-widest border-b-2 border-blue-100 pb-1 hover:border-blue-300 transition-all font-mono">Print History Report</button>
                                </div>
                                <div className="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                                    <table className="w-full text-left font-mono">
                                        <thead className="bg-slate-50 border-b border-slate-200">
                                            <tr>
                                                <th className="p-5 px-8 uppercase font-black text-slate-400 tracking-[0.2em] text-[9px] font-mono">Date</th>
                                                <th className="p-5 px-8 uppercase font-black text-slate-400 tracking-[0.2em] text-[9px] font-mono">Service</th>
                                                <th className="p-5 px-8 uppercase font-black text-slate-400 tracking-[0.2em] text-[9px] text-right font-mono font-mono">Mileage</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100 font-mono">
                                            {records.sort((a,b) => new Date(b.date)-new Date(a.date)).map(r => (
                                                <tr key={r.id} className="hover:bg-slate-50/50 transition-colors font-mono font-bold leading-none">
                                                    <td className="p-6 px-8 font-black text-slate-400 text-[10px] uppercase tracking-widest font-mono font-mono leading-none">{formatDate(r.date)}</td>
                                                    <td className="p-6 px-8 font-black uppercase text-slate-900 text-sm tracking-tight font-mono leading-none">{r.serviceType}</td>
                                                    <td className="p-6 px-8 font-mono font-black text-blue-600 text-right text-sm font-mono leading-none">{r.mileage.toLocaleString()} mi</td>
                                                </tr>
                                            ))}
                                            {records.length === 0 && <tr><td colSpan="3" className="p-20 text-center text-slate-300 font-black uppercase tracking-widest font-mono">No record found</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>

                    {showForm && !isGuest && <ServiceForm user={user} db={db} appId={appId} schedule={schedule} onClose={() => setShowForm(false)} />}
                    {showSched && !isGuest && <ScheduleManager user={user} db={db} appId={appId} currentSchedule={schedule} onClose={() => setShowSched(false)} onUpdate={setSchedule} />}
                    {showIdentity && !isGuest && <VehicleProfileModal user={user} db={db} appId={appId} currentProfile={vehicleProfile} onClose={() => setShowIdentity(false)} onUpdate={setVehicleProfile} />}
                    {showShare && !isGuest && <ShareAccessModal user={user} db={db} appId={appId} currentData={{records, schedule, odo: currentOdo, profile: vehicleProfile}} onClose={() => setShowShare(false)} />}
                    {showAudit && <FullAuditReport records={records} vehicleProfile={vehicleProfile} onClose={() => setShowAudit(false)} />}
                </div>
            );
        };

        const AppWrapper = () => {
            const [ready, setReady] = React.useState(!!window.firebaseModules);
            const [error, setError] = React.useState(null);
            React.useEffect(() => {
                if (window.firebaseModules) setReady(true);
                else {
                    const h = () => setReady(true);
                    window.addEventListener('firebase-ready', h);
                    const t = setTimeout(() => { if (!window.firebaseModules) setError("Core connection failed."); }, 5000);
                    return () => { window.removeEventListener('firebase-ready', h); clearTimeout(t); };
                }
            }, []);
            if (error) return <div className="h-screen bg-[#fcfdfe] flex items-center justify-center p-6 text-center font-mono"><div className="bg-red-50 p-8 rounded-3xl border border-red-100 text-red-600 font-black uppercase tracking-[0.4em] text-[10px] shadow-xl shadow-red-100">{error}</div></div>;
            return ready ? <App /> : (
                <div className="h-screen bg-white flex flex-col items-center justify-center p-8">
                    <div className="w-full max-w-xs space-y-12 fade-in">
                        <div className="flex justify-center mb-10"><CarIcon size={48} className="text-blue-600 animate-pulse" /></div>
                        <div className="space-y-6 text-center font-mono font-bold">
                            <h2 className="text-xs font-black uppercase tracking-[0.6em] text-slate-400 leading-none mb-1 font-mono font-bold">Booting</h2>
                            <div className="loader-line"></div>
                            <p className="text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest font-mono font-bold">Maintenance Console</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppWrapper />);
    </script>
</body>
</html>
